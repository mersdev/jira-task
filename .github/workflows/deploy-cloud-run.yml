name: Deploy Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy-cloud-run.yml'
  workflow_dispatch: {}

env:
  PROJECT_ID: gen-lang-client-0725350933
  REGION: us-central1
  BACKEND_SERVICE: jira-task-backend
  FRONTEND_SERVICE: jira-task-frontend
  ARTIFACT_REPO: jira-task

jobs:
  deploy_backend:
    name: Deploy Backend
    uses: ./.github/workflows/deploy-cloud-run-reusable.yml
    secrets:
      gcp_workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
    with:
      project_id: ${{ env.PROJECT_ID }}
      region: ${{ env.REGION }}
      artifact_repo: ${{ env.ARTIFACT_REPO }}
      service_name: ${{ env.BACKEND_SERVICE }}
      image_context: ./backend
      test_command: |
        cd backend
        bundle install --jobs=4 --retry=3
        bundle exec rails test
      deploy_args: |
        --allow-unauthenticated \
        --cpu 1 \
        --memory 512Mi \
        --min-instances 0 \
        --max-instances 1 \
        --set-env-vars RAILS_ENV=production

  deploy_frontend:
    name: Deploy Frontend
    uses: ./.github/workflows/deploy-cloud-run-reusable.yml
    secrets:
      gcp_workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
    with:
      project_id: ${{ env.PROJECT_ID }}
      region: ${{ env.REGION }}
      artifact_repo: ${{ env.ARTIFACT_REPO }}
      service_name: ${{ env.FRONTEND_SERVICE }}
      image_context: ./frontend
      test_command: |
        cd frontend
        npm ci
        npm run test --if-present
      deploy_args: |
        --allow-unauthenticated \
        --cpu 1 \
        --memory 512Mi \
        --min-instances 0 \
        --max-instances 1 \
        --port 80
