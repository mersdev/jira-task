name: Deploy to Koyeb

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  KOYEB_API_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Koyeb CLI
        run: |
          mkdir -p $HOME/.koyeb/bin
          curl -fsSL https://raw.githubusercontent.com/koyeb/koyeb-cli/master/install.sh | sh
          echo "$HOME/.koyeb/bin" >> $GITHUB_PATH

      - name: Verify Koyeb CLI installation
        run: koyeb version

      - name: Create Koyeb config
        run: |
          mkdir -p $HOME
          cat > $HOME/.koyeb.yaml << EOF
          token: $KOYEB_API_TOKEN
          EOF

      - name: Deploy backend to Koyeb
        id: deploy-backend
        run: |
          koyeb app init "backend" \
            --org "${{ secrets.KOYEB_ORG }}" \
            --region "${{ secrets.KOYEB_REGION }}" || true

          koyeb service create "backend/backend" \
            --git "github.com/${{ github.repository }}" \
            --git-branch "${{ github.ref_name }}" \
            --run-command "bundle exec rails server -b 0.0.0.0 -p 3000" \
            --ports "3000:http" \
            --env "RAILS_ENV=production,RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }},DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            --org "${{ secrets.KOYEB_ORG }}" \
            --region "${{ secrets.KOYEB_REGION }}" || true

          koyeb service get "backend/backend" -o yaml > backend-service.yaml
          cat backend-service.yaml

      - name: Get backend URL
        id: backend-url
        run: |
          sleep 5
          BACKEND_URL=$(koyeb service get "backend/backend" -o json | jq -r '.routes[0].url')
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $BACKEND_URL"

      - name: Deploy frontend to Koyeb
        id: deploy-frontend
        run: |
          koyeb app init "frontend" \
            --org "${{ secrets.KOYEB_ORG }}" \
            --region "${{ secrets.KOYEB_REGION }}" || true

          koyeb service create "frontend/frontend" \
            --git "github.com/${{ github.repository }}" \
            --git-branch "${{ github.ref_name }}" \
            --builder "docker" \
            --ports "80:http" \
            --env "BACKEND_URL=${{ steps.backend-url.outputs.BACKEND_URL }}" \
            --org "${{ secrets.KOYEB_ORG }}" \
            --region "${{ secrets.KOYEB_REGION }}" || true

      - name: Display deployment URLs
        run: |
          echo "=== Deployment Complete ==="
          echo "Backend: $(koyeb service get "backend/backend" -o json | jq -r '.routes[0].url')"
          echo "Frontend: $(koyeb service get "frontend/frontend" -o json | jq -r '.routes[0].url')"
